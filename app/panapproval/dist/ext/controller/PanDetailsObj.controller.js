sap.ui.define(["sap/ui/core/mvc/ControllerExtension"],function(e){"use strict";var t;return e.extend("panapproval.ext.controller.PanDetailsObj",{override:{onInit:function(){var e=this.base.getExtensionAPI().getModel()},onBeforeRendering:async function(){},onAfterRendering:async function(){},routing:{onBeforeBinding:async function(e){this.getView().setVisible(false);var n=this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].setUploadEnabled(false);var o=this;var a=window.location.href;var i=a.split("(");var s=i[1];var g=s.split("'");var r=this.base.getExtensionAPI().getModel();var l="validateUser";let m=r.bindContext(`/${l}(...)`);m.setParameter("ID",g[1]);await m.execute();let d=m.getBoundContext();let c=d.getObject();var u=JSON.parse(c.value);if(u.status=="User Found"){this.getView().setVisible(true);var p=this.base.getView().getContent()[0];p.attachSectionChange(function(){var e=this.getScrollingSectionId();var t=sap.ui.getCore().byId(`${e}`).mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.content.mAggregations.columns;if(t!=undefined)t.forEach(t=>{let n=t.mProperties.dataProperty;let o=n.length;let a=sap.ui.getCore().byId(`${e}`).mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.content.mAggregations._content.mBindingInfos.rows.binding.oCache.getValue();const i=Math.max(...a.map(e=>e[n]?.length??8));if(i>o)o=i;const s=o*8+20+"px";t.setWidth(s)})});debugger;var f=this.base.getAppComponent().getManifestObject()._oBaseUri._string;await $.ajax({url:f+`odata/v4/pan-approval/PAN_Details_APR/${g[1]}`,success:function(e){o.getView().getContent()[0].getFooter().setVisible(true);if(e.status=="Approved"||e.status=="Rejected"||e.status=="Justification Needed")o.getView().getContent()[0].getFooter().setVisible(false)},error:function(e,t,n){console.error(n)}});await $.ajax({url:f+`odata/v4/pan-approval/PAN_Details_APR/${g[1]}/tab1toWORKFLOW_HISTORY`,success:function(e){console.log(e);C(e)},error:function(e,t,n){console.error(n)}});function C(e){var n=e.value;var a=[];n.forEach(e=>{a.push({level:e.level,Notification_Status:e.Notification_Status,Title:e.Title,Employee_ID:e.Employee_ID,Employee_Name:e.Employee_Name,"Begin_Date/_Time":e.Begin_DateAND_Time,"End_Date/_Time":e.End_DateAND_Time,Days_Taken:e.Days_Taken,Status:e.Result,By_User:e.Approved_by})});let i=o.base.getView().getContent()[0].getSections()[3];let s=a.sort((e,t)=>e.level>t.level?1:e.level<t.level?-1:0);let g=[];let r=[];let l;let m;let d=s.length-1;s.forEach((e,t)=>{l=e.level;if(m!=undefined){if(l!==m){g.push(r);r=[]}}r.push(e);m=e.level;if(t==d){g.push(r)}});i.destroySubSections();i.addSubSection(new sap.uxap.ObjectPageSubSection({}));let c=i.getSubSections();let u=c[c.length-1];u.addBlock(new sap.m.ScrollContainer({horizontal:true,vertical:true,visible:true,height:"200px"}));let p=u.getBlocks()[0];p.addContent(new sap.m.HBox({width:"100%",alignItems:"End",alignContent:"End"}));let f=p.getContent();let C=f[f.length-1];C.addItem(new sap.m.HBox({width:"90%"}));C.addItem(new sap.m.Button({text:"Comment History",press:async function(e){function n(){var e=Math.floor(Math.random()*1e6);var t=(new Date).getTime();var n=t+"-"+e;return n}if(!t){t=new sap.m.Dialog({title:"Approval Comments",endButton:new sap.m.Button({text:"Close",press:async function(){t.close()},layoutData:new sap.m.FlexItemData({growFactor:5,alignSelf:"End"})})})}t.addContent(new sap.m.VBox({width:"60vw"}));let o="getcomments";let a=e.getSource().getModel().bindContext(`/${o}(...)`);console.log();var i=window.location.href;var s=i.split("(");var g=s[1];var r=g.split("'");var l=r[1];a.setParameter("ID",l);await a.execute();const m=a.getBoundContext();let d=m.getValue();d=JSON.parse(d.value);const c=[];const u=d[0];if(u==undefined){var p=new sap.suite.ui.commons.TimelineItem({text:"No Comments Found"});t.getContent()[0].destroyItems();t.getContent()[0].addItem(p)}else{d.forEach(e=>{const t=e.createdAt;const n=e.createdBy;const o=e.modifiedAt;const a=e.modifiedBy;const i=e.idd;const s=e.PAN_Number;const g=e.user;const r=e.Comments;const l=e.status;c.push({firsname:g,lname:l,comment:r,dateTime:t})});t.getContent()[0].destroyItems();for(let e=0;e<c.length;e++){var p=new sap.suite.ui.commons.TimelineItem({id:`${"item"+n()}`,dateTime:`${c[e].dateTime}`,title:`${c[e].lname}`,userNameClickable:false,userNameClicked:"onUserNameClick",select:"onPressItems",userPicture:"Photo",text:`${c[e].comment}`,userName:`${c[e].firsname}`});t.mAggregations.content[0].addItem(p)}}t.open()}}));g.forEach(e=>{p.addContent(new sap.uxap.ObjectPageSubSection({}));let t=p.getContent();let n=t[t.length-1];n.addBlock(new sap.m.VBox(`Box-${e[0].level}`));let o=n.getBlocks()[0];o.addItem(new sap.m.HBox({alignItems:"Center"}));let a=o.getItems()[0];a.addItem(new sap.m.Label({text:`Level ${e[0].level}`,design:"Bold"}));a.addItem(new sap.m.HBox({width:"40%"}));a.addItem(new sap.m.Label({text:`Notification: `}));a.addItem(new sap.m.Switch(`SwitchLevel--${e[0].level}`,{enabled:false,type:"AcceptReject",state:e[0].Notification_Status==="true",change:function(e){}}));o.addItem(new sap.m.Table({visible:true}));let i=o.getItems()[1];let s=Object.keys(e[0]);s=s.slice(2);let g=[];s.forEach(e=>{if(!g.includes(e)){var t=new sap.m.Column({header:new sap.m.Label({text:e.replace(/_/g," ")}),width:"200px"});i.addColumn(t);g.push(e)}});e.forEach(e=>{let t=[];let n;let o=Object.values(e);o=o.slice(2);let a;o.forEach(e=>{a=new sap.m.Text({text:e});t.push(a)});n=new sap.m.ColumnListItem({cells:t});i.addItem(n)})})}this.getView().getContent()[0].mAggregations.sections[4].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getContent().setEditable(true);this.getView().getContent()[0].mAggregations.sections[4].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getContent().getFormContainers()[0].getFormElements()[0].getFields()[0].getContent().setEditMode("Editable");this.getView().getContent()[0].mAggregations.sections[4].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getContent().getFormContainers()[0].getFormElements()[0].getFields()[0].getContent().getContentEdit()[0].setEditable(true);sap.ui.getCore().byId("panapproval::PAN_Details_APRObjectPage--fe::FooterBar").setEnabled(true)}else{alert("You are Unauthorized to access this site!!")}},onAfterBinding:function(e){var t=e.oBinding.sPath;const n=/'([^']+)'/;const o=t.match(n);const a=o[1];var i=this.base.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].mBindingInfos.items.binding;i.filter(new sap.ui.model.Filter({path:"PAN_Number",operator:sap.ui.model.FilterOperator.EQ,value1:a}))}}}})});